# Malware Protection Using an AWS Network Firewall

## Lab overview 
Malware is harmful software created by cybercriminals to steal data or damage computer systems. Common types include viruses, worms, Trojans, spyware, adware, and ransomware. Because users need internet access for work, they can accidentally download malware, which threatens network and data security. To reduce these risks, organizations use defenses like firewalls, antivirus tools, and user access controls. This lab focuses specifically on using firewalls as a key countermeasure to protect internal networks from unauthorized external access
---

## scenario 
AnyCompany has hired you as a new security engineer, and the company has tasked you with hardening the company’s security perimeter. There have been reports of users accidentally downloading malware after accessing specific websites. The IT team for AnyCompany has provided you with the URLs of the sites hosting the malware. It is your job to find a solution to mitigate access to these malicious actor files.
---

## In this Lab
you work with a pre-configured EC2 TestInstance placed in a secure perimeter zone to safely test access to a website containing malicious files. Your tasks include updating the AnyCompany network firewall, creating a rules group, and attaching it to both a firewall policy and the network firewall. After configuring the firewall, you log in to the TestInstance to verify that the protections work. All necessary backend components—like EC2 resources, IAM roles, and supporting AWS services—are already set up for you.
---

### Task 1: Confirm Reachabulity 

1. From the Vocareum console page, choose the  AWS Details button.
 -Next to TestInstanceURL, there is a link. Copy and paste the link into a new tab in your web browser.
 -This link directly logs you into the TestInstance EC2 server via AWS Systems Manager Session Manager.

2. To change directories and view the current working directory, run the following commands:
`cd ~
 pwd`

3. In this protected lab environment, enter the following code and press Enter to download part of the malware:
  `wget http://malware.wicar.org/data/js_crypto_miner.html`

4. In this protected lab environment, enter the following code and press Enter to download the rest of the malware:
`wget http://malware.wicar.org/data/java_jre17_exec.html`
![alt text](<Screenshot 2025-12-11 163058.png>)

5. To view the downloaded files, run the following command:
`ls`
![alt text](<Screenshot 2025-12-11 180450.png>)
---

### Task 2: Inspect the network firewall

1. In the AWS Management Console, enter VPC in the search  bar, and then choose VPC.
2. In the left navigation pane under NETWORK FIREWALL, choose Firewalls.
3. In Step 2: Configure the firewall policy, choose the LabFirewallPolicy link to open the associated policy.
4. For Stateless default actions, configure the following options:
 -Choose how to treat fragmented packets: Choose Use the same actions for all packets.
 -Action: Choose Forward to stateful rule groups.

5. Choose Save.
![alt text](<Screenshot 2025-12-11 163603.png>)
---

### Task 3: Create a filawall rule group

1. In the left navigation pane under NETWORK FIREWALL, choose Network Firewall Rule Groups.
2. Choose Create Network Firewall rule group. 
3. In the Create rule group section, configure the following options:
 -For Rule group type, choose Stateful rule group.
 -For Rule group format choose Suricata compatible rule string. 
 -For Rule evaluation order choose Action order. Choose Next.
 -In the Rule group details section, configure the following options:
  -Name: Enter StatefulRuleGroup
  -Capacity: Enter 100
4. Choose Next.
5. In the Suricata compatible IPS rules section, enter the following code into the text box:

```
drop http $HOME_NET any -> $EXTERNAL_NET 80 (msg:"MALWARE custom solution"; flow: to_server,established; classtype:trojan-activity; sid:2002001; content:"/data/js_crypto_miner.html";http_uri; rev:1;)

drop http $HOME_NET any -> $EXTERNAL_NET 80 (msg:"MALWARE custom solution"; flow: to_server,established; classtype:trojan-activity; sid:2002002; content:"/data/java_jre17_exec.html";http_uri; rev:1;)
```

6. Choose Next a few times to skip to the Review and create section. Finally Create stateful rule group.
![alt text](<Screenshot 2025-12-11 163917.png>) 
![alt text](<Screenshot 2025-12-11 164403.png>)
---

### Task 3: Attach a rule group to the network firewall

1. In the left navigation pane under NETWORK FIREWALL, choose Firewalls.
2. Choose LabFirewall.
3. Under Associated firewall policy, select the LabFirewallPolicy. Under Stateful rule groups select the dropdown list, and then choose Add unmanaged stateful rule groups.

4. Select the check box for StatefulRuleGroup, and then choose Add stateful rule group.

 -At the top of the page, you should see a green You successfully updated FirewallPolicy banner.
![alt text](<Screenshot 2025-12-11 175925.png>)
---

### Task 4:Attach a rule group to the network firewall

1. In the left navigation pane under NETWORK FIREWALL, choose Firewalls.

2. Choose LabFirewall.

3. Under Associated firewall policy, select the LabFirewallPolicy. Under Stateful rule groups select the dropdown list, and then choose Add unmanaged stateful rule groups.

4. Select the check box for StatefulRuleGroup, and then choose Add stateful rule group.

 -At the top of the page, you should see a green You successfully updated FirewallPolicy banner.

![alt text](<Screenshot 2025-12-11 163603-2.png>)
---

### Task 5: Validate the solution

1. In the AWS Management Console, enter EC2 in the search  bar, and then choose EC2.
2. In the left navigation pane, choose Instances.
3. Select the check box next for TestInstance, and then choose Connect.
4. Choose the Session Manager tab, and then choose Connect.
5. To change directories and view the current working directory, run the following commands:
`cd ~
pwd `

6. To try and access the first malicious file, run the following wget command.
`wget http://malware.wicar.org/data/js_crypto_miner.html`

The output should display the following:
`HTTP request sent, awaiting response...`

7. Press Ctrl+c to stop the command.
8. To test access to the other malicious URL, run the following command:
`wget http://malware.wicar.org/data/java_jre17_exec.html`

The output should display the following:
`HTTP request sent, awaiting response...`

9. Next, to remove the test malware files, run the following command:
`rm java_jre17_exec.html js_crypto_miner.html`

10. To confirm that the files were deleted, run the ls command:
`ls`

![alt text](<Screenshot 2025-12-11 180450-1.png>)
